angular.module("cms.pages",["ngRoute","cms.shared"]).constant("_",window._).constant("pages.modulePath","/Admin/Modules/Pages/Js/");
angular.module("cms.pages").config(["$routeProvider","shared.routingUtilities","pages.modulePath",function(e,i,a){a=i.mapOptions.bind(null,a);e.when("/new",a("AddPage")).when("/:id",a("PageDetails")).otherwise(a("PageList"))}]);
angular.module("cms.pages").factory("pages.customEntityService",["$http","shared.serviceBase",function(t,e){var r={getAllRoutingRules:function(){return t.get(e+"custom-entity-routing-rules/")}};return r}]);
angular.module("cms.pages").factory("pages.directoryService",["$http","_","shared.serviceBase",function(e,r,t){var a={},c=t+"page-directories";return a.getAll=function(){return e.get(c)},a}]);
angular.module("cms.pages").factory("pages.pageTemplateService",["$http","$q","shared.serviceBase",function(a,e,t){var n={},r=t+"page-templates";return n.getAll=function(){var t=e.defer();return a.get(r).then(function(e){t.resolve(e.items)},t.reject),t.promise},n.getExtensionDataModelSchemas=function(e){return a.get(r+"/"+e+"/extension-data-model-schemas")},n}]);
angular.module("cms.pages").controller("ChangePageUrlController",["$scope","$q","$location","shared.LoadState","shared.pageService","pages.customEntityService","options","close",function(o,t,e,a,n,r,l,i){var u=t.defer(),s=t.defer();function c(){o.submitLoadState.on(),n.updateUrl(o.command).then(l.onSave).then(i).finally(o.submitLoadState.off)}(function(){var e=l.page,t=e.pageRoute;o.isCustomEntityRoute="CustomEntityDetails"===t.pageType,o.page=e,o.command={pageId:e.pageId,localeId:t.locale?t.locale.localeId:void 0,pageDirectoryId:t.pageDirectory.pageDirectoryId},o.isCustomEntityRoute?o.command.customEntityRoutingRule=t.urlPath:o.command.urlPath=t.urlPath})(),o.submitLoadState=new a,o.formLoadState=new a(!0),o.save=c,o.close=i,o.localesLoaded=u.resolve,o.pageDirectoriesLoaded=s.resolve,o.formLoadState.offWhen(u,s,function(){if(o.isCustomEntityRoute)return r.getAllRoutingRules().then(function(e){o.routingRules=e});var e=t.defer();return e.resolve(),e}())}]);
angular.module("cms.pages").controller("DuplicatePageController",["$scope","$q","$location","shared.stringUtilities","shared.LoadState","shared.pageService","pages.customEntityService","options","close",function(o,t,a,e,i,n,l,r,s){var u=t.defer(),c=t.defer();function d(){o.isCustomEntityRoute||(o.command.urlPath=e.slugify(o.command.title,200))}function m(){o.submitLoadState.on(),n.duplicate(o.command).then(g).then(s).finally(o.submitLoadState.off)}function g(e){a.path("/"+e)}(function(){var e=r.page,t=e.pageRoute;o.isCustomEntityRoute="CustomEntityDetails"===t.pageType,o.page=e,o.command={pageToDuplicateId:e.pageId,localeId:t.locale?t.locale.localeId:void 0,pageDirectoryId:t.pageDirectory.pageDirectoryId,title:"Copy of "+e.latestVersion.title},o.isCustomEntityRoute?o.command.customEntityRoutingRule=t.urlPath:d()})(),o.submitLoadState=new i,o.formLoadState=new i(!0),o.save=m,o.close=s,o.onTitleChanged=d,o.localesLoaded=u.resolve,o.pageDirectoriesLoaded=c.resolve,o.formLoadState.offWhen(u,c,function(){if(o.isCustomEntityRoute)return l.getAllRoutingRules().then(function(e){o.routingRules=e});var e=t.defer();return e.resolve(),e}())}]);
angular.module("cms.pages").controller("AddPageController",["_","$scope","$q","$location","$window","shared.LoadState","shared.stringUtilities","shared.urlLibrary","shared.pageService","pages.pageTemplateService","pages.customEntityService",function(t,n,e,a,o,l,i,d,s,c,m){var u=this,r=e.defer(),g=e.defer();function p(e,a){var n=e?(u.command.publish=!0,u.saveAndPublishLoadState):u.saveLoadState;"CustomEntityDetails"==u.command.pageType?u.command.urlPath=void 0:u.command.customEntityRoutingRule=void 0,e=n,u.globalLoadState.on(),e&&t.isFunction(e.on)&&e.on(),s.add(u.command).then(a).finally(function(e){u.globalLoadState.off(),e&&t.isFunction(e.off)&&e.off()}.bind(null,n))}function f(e){a.path("/"+e)}function h(e){return s.getById(e).then(function(e){o.location.href=d.visualEditorForPage(e.pageRoute,!0)})}function v(){u.command.urlPath=i.slugify(u.command.title,200)}function y(){var e=u.command.pageType,e="CustomEntityDetails"==e?e:"Generic";u.pageTemplates=t.where(u.allPageTemplates,{pageType:e})}function S(){function a(e){var a=u.command.extensionData[e.name]||{};e.defaultValue&&e.defaultValue.value?u.command.extensionData[e.name]=t.extend(angular.copy(e.defaultValue.value),a):u.command.extensionData[e.name]=a,u.extensionDataSources.push({model:u.command.extensionData[e.name],modelMetaData:e})}c.getExtensionDataModelSchemas(u.command.pageTemplateId).then(function(e){u.command.extensionData=u.command.extensionData||{},u.extensionDataSources=[],t.each(e,a)})}function L(){a.path("/")}u.save=p.bind(null,!1,f),u.saveAndPublish=p.bind(null,!0,f),u.saveAndEdit=p.bind(null,!1,h),u.cancel=L,u.onNameChanged=v,u.onPageTypeChanged=y,u.onPageTemplateChanged=S,u.globalLoadState=new l,u.saveLoadState=new l,u.saveAndPublishLoadState=new l,u.formLoadState=new l(!0),u.onLocalesLoaded=r.resolve,u.onPageDirectoriesLoaded=g.resolve,function(){u.pageTypes=s.getPageTypes(),u.command={showInSiteMap:!0,pageType:u.pageTypes[0].value};var e=c.getAll().then(function(e){u.allPageTemplates=e}),a=m.getAllRoutingRules().then(function(e){u.routingRules=e});u.formLoadState.offWhen(r,g,e,a).then(y),n.$watch("vm.command.localeId",function(e){u.additionalParameters=e?{localeId:e}:{}})}()}]);
angular.module("cms.pages").controller("PageDetailsController",["$routeParams","$q","$location","_","shared.LoadState","shared.SearchQuery","shared.modalDialogService","shared.entityVersionModalDialogService","shared.urlLibrary","shared.pageService","shared.permissionValidationService","shared.userAreaService","shared.internalModulePath","pages.pageTemplateService","pages.modulePath",function(a,t,e,n,o,i,s,r,l,u,d,c,p,g,h){var f=this,m="COFPGE";function b(){f.editMode=!0,f.mainForm.formStatus.clear()}function P(e){e=e?(f.updateDraftCommand.publish=!0,f.saveAndPublishLoadState):f.saveLoadState;B(e),u.update(f.updatePageCommand).then(u.updateDraft.bind(this,f.updateDraftCommand)).then(U.bind(null,"Changes were saved successfully")).finally(G.bind(null,e))}function D(){f.editMode=!1,f.updatePageCommand=T(f.page),f.updateDraftCommand=k(f.page),f.mainForm.formStatus.clear()}function S(){r.publish(f.page.pageId,B).then(U.bind(null,"Page published successfully.")).catch(G)}function v(){r.unpublish(f.page.pageId,B).then(U.bind(null,"The page has been unpublished and reverted to draft state.")).catch(G)}function y(){var e={title:"Discard Version",message:"Are you sure you want to discard this draft? This will discard all changes since the page was last published.",okButtonTitle:"Yes, discard it",onOk:function(){return B(),u.removeDraft(f.page.pageId)}};s.confirm(e).then(U.bind(null,"Draft discarded successfully"))}function I(e){r.copyToDraft(f.page.pageId,e.pageVersionId,f.page.pageRoute.hasDraftVersion,B).then(function(){U("Draft created successfully.")}).catch(G)}function w(){var e={title:"Delete Page",message:"Are you sure you want to delete this page?",okButtonTitle:"Yes, delete it",onOk:function(){return B(),u.remove(f.page.pageId).then(x).catch(G)}};s.confirm(e)}function C(){s.show({templateUrl:h+"Routes/Modals/DuplicatePage.html",controller:"DuplicatePageController",options:{page:f.page}})}function L(){s.show({templateUrl:h+"Routes/Modals/ChangePageUrl.html",controller:"ChangePageUrlController",options:{page:f.page,onSave:U.bind(null,"Url Changed")}})}function A(){s.show({templateUrl:p+"UIComponents/EntityAccess/EntityAccessEditor.html",controller:"EntityAccessEditorController",options:{entityDefinitionCode:m,entityIdPrefix:"page",entityDefinitionName:"Page",entityDescription:f.page.pageRoute.fullUrlPath,entityAccessLoader:function(){return u.getAccessRulesByPageId(f.page.pageId)},saveAccess:u.updateAccessRules}})}function U(e,a){return R(a).then(f.mainForm.formStatus.success.bind(null,e))}function R(e){return t.all([u.getById(a.id).then(function(e){return f.page=e,f.updatePageCommand=T(e),f.updateDraftCommand=k(e),f.editMode=!1,f.isMarkedPublished="Published"==f.page.pageRoute.publishStatus,f.publishStatusLabel=F(e.pageRoute),f.page.pageRoute.locale?f.additionalParameters={localeId:f.page.pageRoute.locale.localeId}:f.additionalParameters={},e}),V(),c.getAll().then(function(e){f.accessRulesEnabled=1<e.length})]).then(function(e){return E(e[1]),e=e[0],g.getExtensionDataModelSchemas(e.latestVersion.template.pageTemplateId).then(function(e){f.extensionDataSources=[],n.each(e,a)});function a(e){f.extensionDataSources.push({model:f.updateDraftCommand.extensionData[e.name],modelMetaData:e})}}).then(G.bind(null,e))}function M(){return f.versionsLoadState.on(),V().then(E).then(G.bind(null,f.versionsLoadState))}function V(){return u.getVersionsByPageId(a.id,f.versionsQuery.getParameters())}function E(e){var a=f.page,t=a.pageRoute.isPublished();n.each(e.items,function(e){e.versionLabel=function(e,a){if("Draft"==e.workFlowStatus)return e.workFlowStatus;var t="V"+e.displayVersion;return e.isLatestPublishedVersion?t+" ("+F(a)+")":t}(e,a.pageRoute),e.browseUrl=f.urlLibrary.visualEditorForVersion(a.pageRoute,e,!1,t)}),f.versions=e}function F(e){return"Published"==e.publishStatus&&e.publishDate<Date.now()?"Pending Publish":e.publishStatus}function T(e){return{pageId:e.pageId,tags:e.tags}}function k(e){var a=e.latestVersion,t=a.openGraph;return{pageId:e.pageId,title:a.title,metaDescription:a.metaDescription,openGraphTitle:t.title,openGraphDescription:t.description,openGraphImageId:t.image?t.image.ImageAssetId:void 0,showInSiteMap:a.showInSiteMap,extensionData:a.extensionData}}function x(){e.path("")}function B(e){f.globalLoadState.on(),e&&n.isFunction(e.on)&&e.on()}function G(e){f.globalLoadState.off(),e&&n.isFunction(e.off)&&e.off()}f.edit=b,f.save=P.bind(null,!1),f.saveAndPublish=P.bind(null,!0),f.cancel=D,f.publish=S,f.unpublish=v,f.discardDraft=y,f.copyToDraft=I,f.deletePage=w,f.duplicatePage=C,f.changeUrl=L,f.viewAccessRules=A,f.editMode=!1,f.globalLoadState=new o,f.saveLoadState=new o,f.saveAndPublishLoadState=new o,f.formLoadState=new o(!0),f.versionsLoadState=new o,f.urlLibrary=l,f.versionsQuery=new i({onChanged:M,useHistory:!1,defaultParams:{pageSize:6}}),f.canCreate=d.canCreate(m),f.canUpdate=d.canUpdate(m),f.canDelete=d.canDelete(m),f.canPublishPage=d.hasPermission(m+"PAGPUB"),f.canUpdatePageUrl=d.hasPermission(m+"UPDURL"),R(f.formLoadState)}]);
angular.module("cms.pages").controller("PageListController",["_","shared.entityVersionModalDialogService","shared.LoadState","shared.SearchQuery","shared.pageService","shared.permissionValidationService","pages.pageTemplateService",function(a,t,e,n,i,l,r){var o=this;function s(e){o.isFilterVisible=a.isUndefined(e)?!o.isFilterVisible:e}function d(e){t.publish(e,o.globalLoadState.on).then(u).then(o.globalLoadState.off).catch(o.globalLoadState.off)}function g(){s(!1),u()}function u(){return o.gridLoadState.on(),i.getAll(o.query.getParameters()).then(function(e){o.result=e,o.gridLoadState.off()})}o.publishStatus=[{name:"Unpublished"},{name:"Published"}],r.getAll().then(function(e){o.pageTemplates=e}),o.gridLoadState=new e,o.globalLoadState=new e,o.query=new n({onChanged:g}),o.filter=o.query.getFilters(),o.toggleFilter=s,s(!1),o.publish=d,o.canCreate=l.canCreate("COFPGE"),o.canUpdate=l.canUpdate("COFPGE"),u()}]);